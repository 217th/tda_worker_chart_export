openapi: 3.1.0
# -----------------------------------------------------------------------------
# TDA (Trading Decisions Assistant) Production Trigger API (prototype)
#
# Назначение:
# - production-safe entrypoint для создания `flow_runs/{runId}`
# - НЕ содержит debug-операций (simulate/advance/cancel)
# - IAM-only (внутренний доступ)
# -----------------------------------------------------------------------------
info:
  title: TDA Production Trigger API (prototype)
  version: 0.1.0
  license:
    name: Proprietary
    url: https://run-trigger.example.internal/license
  description: |
    Production entrypoint для запуска флоу (создания `flow_runs/{runId}`).
servers:
  - url: https://run-trigger.example.internal
    description: Internal endpoint (Cloud Run Functions, IAM-protected).

security:
  - bearerAuth: []

paths:
  /runs:trigger:
    post:
      summary: Trigger new run (create flow_run)
      description: |
        Создаёт новый `flow_runs/{runId}` и возвращает созданный документ.

        Требования к реализации:
        - строгая валидация входа (allowlist flowKey + формат symbol)
        - поддержка идемпотентности (например через `Idempotency-Key`)
      operationId: triggerRunProd
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
          description: |
            Опциональный ключ идемпотентности для безопасных ретраев клиента/планировщика.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunTriggerRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "../schemas/flow_run.schema.json"
        "400":
          description: Bad request (validation failed)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorDTO"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorDTO"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorDTO"
        "409":
          description: Conflict (duplicate Idempotency-Key or invalid transition)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorDTO"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorDTO"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorDTO:
      type: object
      additionalProperties: false
      required: [code, message]
      properties:
        code:
          type: string
          description: |
            Машиночитаемый код ошибки.
          enum:
            - VALIDATION_FAILED
            - NOT_ALLOWED_FLOWKEY
            - INVALID_SYMBOL
            - MISSING_REPORT_IDS
            - IDEMPOTENCY_CONFLICT
            - UNAUTHORIZED
            - FORBIDDEN
            - INTERNAL
        message:
          type: string
          description: Человекочитаемое сообщение.
        requestId:
          type: string
          description: |
            Идентификатор запроса/трейса для корреляции логов (если доступен).
        details:
          type: object
          description: Произвольные детали для диагностики.
          additionalProperties: true

    RunTriggerRequest:
      type: object
      additionalProperties: false
      required: [flowKey, symbol]
      properties:
        flowKey:
          type: string
          description: Allowed production flow template key.
          enum:
            - scheduled_month_week_report_v1
            - user_multi_tf_report_v1
            - recommendation_from_reports_v1
        symbol:
          type: string
          description: |
            Trading symbol. Должен совпадать с `scope.symbol` в создаваемом `flow_run`.
          pattern: "^[A-Z0-9]{2,10}/[A-Z0-9]{2,10}$"
        triggerSource:
          type: string
          description: |
            Произвольная строка-источник триггера (например cloud-scheduler, ops-tool).
          minLength: 1
        idempotencyKey:
          type: string
          description: |
            Опционально: ключ идемпотентности в body (если не используется заголовок).
        reportIds:
          type: array
          description: |
            Обязателен только для `flowKey=recommendation_from_reports_v1`.
          items:
            type: string
            minLength: 1
          minItems: 1
      allOf:
        - if:
            properties:
              flowKey:
                const: recommendation_from_reports_v1
          then:
            required: [reportIds]


