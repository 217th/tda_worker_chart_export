# Verify Report â€” T-023

Date: 2025-12-20
Operator: human (local CLI)
Environment: real GCP (project YOUR_PROJECT_ID, Firestore db YOUR_FIRESTORE_DB, bucket gs://YOUR_ARTIFACTS_BUCKET)

## Scenario: Record + Secret Manager (3 requests)
- Command:
  CHART_IMG_ACCOUNTS_JSON="$(gcloud secrets versions access latest --secret chart-img-accounts --project YOUR_PROJECT_ID)" \
    python -m worker_chart_export.cli run-local \
      --flow-run-path /home/dd-user/projects/tda_worker_chart_export/tmp/flow_run_demo.json \
      --step-id charts:1H:ctpl_price_ma1226_vol_v1 \
      --charts-bucket gs://YOUR_ARTIFACTS_BUCKET \
      --charts-api-mode record
- runId: 20251220-145500_BTCUSDT_demo5
- Expected: step SUCCEEDED, 3 items, manifest in GCS
- Observed:
  - chart_api_call_finished: ok=true (3 calls)
  - step_completed: status=SUCCEEDED, itemsCount=3, failuresCount=0
  - outputsManifestGcsUri: gs://YOUR_ARTIFACTS_BUCKET/runs/20251220-145500_BTCUSDT_demo5/steps/charts:1H:ctpl_price_ma1226_vol_v1/charts/manifest.json
- Result: PASS

## Scenario: Record (1 request, local accounts file)
- Command:
  python -m worker_chart_export.cli run-local \
    --flow-run-path /home/dd-user/projects/tda_worker_chart_export/tmp/flow_run_demo.json \
    --step-id charts:1H:ctpl_price_ma1226_vol_v1 \
    --charts-bucket gs://YOUR_ARTIFACTS_BUCKET \
    --charts-api-mode record \
    --accounts-config-path /home/dd-user/.secrets/tda/chart-img.accounts.local.json
- runId: 20251220-142500_BTCUSDT_demo4
- Expected: step SUCCEEDED, 1 item, manifest in GCS
- Observed:
  - step_completed: status=SUCCEEDED, itemsCount=1, failuresCount=0
  - outputsManifestGcsUri: gs://YOUR_ARTIFACTS_BUCKET/runs/20251220-142500_BTCUSDT_demo4/steps/charts:1H:ctpl_price_ma1226_vol_v1/charts/manifest.json
- Result: PASS

Notes:
- Firestore writes use optimistic update with precondition; no 409 errors during these runs.
- Fixtures created locally under docs-worker-chart-export/fixtures/ (not committed).

## Scenario: CLI invalid stepId
- Command:
  CHART_IMG_ACCOUNTS_JSON="$(gcloud secrets versions access latest --secret chart-img-accounts --project YOUR_PROJECT_ID)" \
    python -m worker_chart_export.cli run-local \
      --flow-run-path /home/dd-user/projects/tda_worker_chart_export/tmp/flow_run_demo.json \
      --step-id charts:1H:NON_EXISTENT_STEP \
      --charts-bucket gs://YOUR_ARTIFACTS_BUCKET \
      --charts-api-mode record
- runId: 20251220-145500_BTCUSDT_demo5
- Expected: exit!=0, errorCode=VALIDATION_FAILED, Firestore unchanged
- Observed: exit=1, CHART_EXPORT FAILED; Firestore step remained SUCCEEDED
- Result: PASS

## Scenario: Idempotent retry (SUCCEEDED)
- Command:
  CHART_IMG_ACCOUNTS_JSON="$(gcloud secrets versions access latest --secret chart-img-accounts --project YOUR_PROJECT_ID)" \
    python -m worker_chart_export.cli run-local \
      --flow-run-path /home/dd-user/projects/tda_worker_chart_export/tmp/flow_run_demo.json \
      --step-id charts:1H:ctpl_price_ma1226_vol_v1 \
      --charts-bucket gs://YOUR_ARTIFACTS_BUCKET \
      --charts-api-mode record
- runId: 20251220-145500_BTCUSDT_demo5
- Expected: no-op, step remains SUCCEEDED
- Observed: claim_attempt claimed=false status=SUCCEEDED, exit=0
- Result: PASS

## Scenario: GCS write failure (bad bucket)
- Command:
  CHART_IMG_ACCOUNTS_JSON="$(gcloud secrets versions access latest --secret chart-img-accounts --project YOUR_PROJECT_ID)" \
    python -m worker_chart_export.cli run-local \
      --flow-run-path /home/dd-user/projects/tda_worker_chart_export/tmp/flow_run_demo.json \
      --step-id charts:1H:ctpl_price_ma1226_vol_v1 \
      --charts-bucket gs://YOUR_ARTIFACTS_BUCKET_TYPO \
      --charts-api-mode record
- runId: 20251220-152000_BTCUSDT_demo7
- Expected: FAILED with GCS_WRITE_FAILED/MANIFEST_WRITE_FAILED
- Observed: FAILED with error.code=MANIFEST_WRITE_FAILED (error: NotFound)
- Result: PASS
